# SoC的互联机制

来源：读书笔记

## 概述

在SOC的设计规化中，如何将片上数量众多、功能各异的功能模块互连，合理解决各模块之间的通信问题，是SOC系统设计的重要工作。

在计算机系统中，广泛采用各种系统总线，实现各功能模块之间的通信，常用的有ISA总线、PCI总线以及I2C, USB等串行总线。计算机系统的这一设计方法很自然地被应用于SOC的系统设计。

然而，这些传统的微型计算机系统的外部总线结构并不适合于片上系统的互连，原因在于**传统的微机总线由于受芯片封装管脚数的限制，常采用三态缓冲器或地址/数据总线分时复用的方法**。此外，微型计算机系统是一板级系统，系统总线在PCB上布线，是一种固定的互连方案，同时总线必须具备大的驱动能力，以驱动很大的PCB板连线和大的负载。因此，**传统的微机总线缺乏对在一片硅片上用于IP核集成应具有的高性能、低功耗、易扩充、易互连等特性的支持。微机系统总线的这些问题，在SOC上却并不存在。**

SOC片内可以提供**丰富的连线资源，总线宽度几乎不受限制**；总线的布线可以根据需要采用不同的结构，可以是并行总线，也可以采用交叉开关，布线资源灵活，从而可以获得良好的系统功能。

就IP核互连的形式而言，主要有共享总线、点对点的连接及多总线几种方式，带宽、时延、数据吞吐率及功耗通常是几个需主要考虑的因素。

共享总线方式是通过不同地址的解码来完成不同主、从部件的互连及总线复用，在多外设IC系统的应用场合，地址总线必须具有较大的驱动能力，同时过于复杂的译码逻辑会增加额外的时延。如果数据主要集中在一个主处理器与一个从外设之间交换数据，则其他的外设在此期间需处于空闲态或高阻态，在多处理器系统中，意味着各处理器不能同时进行数据传输，增加了时延及等待。

**增加总线的宽度、提高总线的时钟、及采用多总线方案**可以解决带宽、时延问题。但增加总线的宽度，只有外围设备能在一个时钟周期内全部占有这些总线时才有效，否则总线的利用率就不高，而提高总线的速度也会受到一定的限制，同时会产生功耗方面的问题。

一个有效的办法就是采用**多总线方案**。多总线的方案有多种实现形式，按不同速率对总线分段可以减少总线的竞争并且提高总线利用率；采用独立的总线读写，以使读写可以同时并行执行；提供多个并行的总线，对主、从部件间进行点对点的连接，以实现一对主、从部件的高速互连。此外，还可采用分层总线、交换矩阵或互连网络等构架，来实现多个主、从部件的同时互连。

##### 基于总线的互连机制

在**基于总线的互连机制**中，经常需要进行**总线仲裁**，总线仲裁方法有多种。总线仲裁实现方法最为简单的是总线循环占用法，各主部件分时循环占用总线；另外还广泛采用**从部件仲裁（Slave-side arbitration）**的方案，在从部件需要数据传送时占有总线，有利于提高总线的利用率。对于流水线传送较多的情况，如何保证读写的流水线执行以减少时延也是总线仲裁考虑的一个重要因素。

由于片上总线是SOC系统设计的关键技术之一，近几年来，许多公司都推出了自己的片上总线，比较有影响力的有：

* ARM公司的AMBA<sup>TM</sup>（Advanced Microcontroller Bus Architecture）
* IBM公司的CoreConnect
* Silicore Colt．公司的WISHBONE
* 开放核心协议国际联盟（OCP-IP）的OCP（Open Core Protocol）总线

##### 基于虚拟元件接口的互连机制

与基于总线的互连机制不同的是**基于虚拟元件接口的互连机制**。

虚拟元件接口（Virtual Component Interface，简称VCI）标准是由虚拟插件接口联盟VSIA（Virtual Socket Interface Alliance，简称VSIA）的片上总线开发工作组提出的，其目的是为了**对不同电路通信接口协议的标准化，改善总线协议机制对IP核的设计重用的限制**。

IP核的开发商众多，作为IP核的开发者，都希望自己的IP产品具有尽可能广泛的应用范围。然而，采用某种特定的总线协议作为IP自身接口的做法将会限制今后的应用市场，这是因为**所有的总线协议都是严格定义的一套模块间的数据流通信方法，一旦IP采用了某种特定的总线协议作为自身接口，那么它与其他不同的总线协议进行集成时必然导致其性能的下降。**

**VCI就是在总线的基础上基于标准的IP接口思想来解决IP核的复用和系统集成**。VCI的基本特征是一类基于地址映射（或存储器映射）的点到点通信协议。发起方（initiator）和目标方（target）都是固定的，发起方发出一个请求，目标方作出响应。基本VCI（Basic VCI，简称BVCI）接口采用分裂协议，即**请求与响应的时序是完全分开的**。主发起方能够发出许多的请求，无需等待每个请求的响应。这种协议对于请求发起与响应到达之间的连接不作任何的规定。唯一被规定的是，响应的顺序必须与请求的顺序相一致。**按照虚拟元件接口的互连策略，IP开发者可以采用独立于总线协议的IP接口规范，而不必关心将来目标系统的情况下独立地开发自己的可复用的IP核。**

## AMBA总线

AMBA总线规范是由ARM公司推出的一种用于高性能嵌入式微处理器设计的片上总线标准，**由于AMBA总线的开放性和其本身的高性能，以及由于ARM处理器的广泛应用，AMBA已成为SOC设计中使用最广泛的总线标准。**

目前AMBA总线规范的版本为3.0，它定义了三组不同的总线：

* AMBA高性能总线AHB（Advanced High-performance Bus）
* AMBA高性能系统总线ASB（Advanced System Bus）
* AMBA高性能外设总线APB（Advanced Peripheral Bus）

AHB作为高性能的系统中枢总线**驱动速度较快的设备，如CPU、DSP、DMA控制器、RAM等**，支持**突发模式的数据传送和事务分隔**，并支持**流水线操作**。

ASB也用于**高性能系统模块的连接**，支持突发模式的数据传送。**这是较老的总线格式，后为AHB总线替代**。

APB则是**作为传送速度较低的外围设备总线，驱动速度较慢的设备，**如UART、定时器、PIO、键盘控制器等，其中**AHB和APB通过总线桥相连**，这个**桥**可以看成是**APB总线上的一个主模块**。

一种典型的基于AMBA总线的系统结构如图所示。

<img src="https://i.loli.net/2021/09/07/iz5LfIlcHvk3OsF.png" alt="image-20210907094418232" style="zoom:50%;" />

图 典型的AMBA构架

### 1．AHB总线

AHB主要用于**高性能模块之间的连接**。

* 主模块：AHB可以有一个或多个主模块，主模块可以是：
  * RSIC处理器
  * DSP以
  * DMA控制器等。

* 从模块：AHB的从模块包括：
  * 片上RAM
  * 外部存储器接口
  * 总线桥等。

作为SOC的片上系统总线，AHB包括以下一些特性：

- 单个时钟边沿操作；
- 非三态的实现方式；
- 支持突发传输；
- 支持分段传输；
- 支持多个主控制器（最多16个模块）；
- 可配置32位～128位总线宽度；
- 支持字节、半字和字的传输。

### 2．AHB总线的接口信号

AHB系统由**主模块（Master）、从模块（Slave）和基础结构（Infrastructure）**3部分组成。

* 整个AHB总线上的**传输都是由主模块发出，由从模块负责回应**。

* 基础结构：由**仲裁器（arbiter）**、主模块到从模块的**多路器**、从模块到主模块的多路器、译码器、虚拟从模块、虚拟主模块等组成。

总线上传输的信号，基本上可以分成**时钟信号、仲裁信号、地址信号、控制信号、写数据、读数据和响应信号**七种。**除了时钟与仲裁信号之外，其余的信号皆通过多路器传送。**

* 经过主模块到从模块的多路器传送的信号有：地址信号、控制信号和写数据。
* 经从模块到主模块多路器传送的信号有：读数据和响应信号。

图6-19给出了AHB总线的互连结构图。

<img src="https://i.loli.net/2021/09/07/sbGmB21dQNnrCAF.png" alt="image-20210907101646874" style="zoom:50%;" />

图 AHB总线的互连

### 3．AHB基本传输

在AHB总线上，一次完整的传输可以分成两个阶段：地址传送阶段与数据传送阶段。

地址传送阶段传送的是**地址与控制信号**，这个阶段只持续一个时钟周期，在HCLK的上升沿数据有效，所有的从模块都在这个上升沿采样地址信息。

而数据传送阶段传送的是读或写的数据和响应信号，这一阶段可以持续一个或几个时钟周期。当数据传送无法在一个时钟周期完成时，可以通过**HREADY信号来延长数据传送周期**，HREADY信号为低电平时，表示传输尚未结束，于是就在数据传送阶段中加入等待周期，直到HREADY信号为高电平为止。

图6-23说明了AHB上的一次基本传输过程。

![image-20210907113101570](https://i.loli.net/2021/09/07/pJvPj3n1efruY9x.png)

图 AHB基本传输过程

<img src="https://i.loli.net/2021/09/07/7WhNZ3abSX2B1TI.png" alt="image-20210907113132902" style="zoom: 33%;" />

图 AHB总线仲裁器接口

由于**一次传输需要两个阶段才能完成，而这两个阶段之间是相互分开的**，为了增进总线的性能，AHB采用**流水线操作**的方法，将两次传输间的地址传送阶段与数据传送阶段重叠在一起，**地址传送阶段实际上发生在前一次传输的数据传送阶段**。

图6-24给出了这种操作的示意图，由图可见由于当前传输的数据传送阶段与下一次传输的地址传送阶段是重叠的，所以当目前传输的数据传送阶段被延长时，下一次传输的地址传送阶段也得相应延长。

![image-20210907113148526](https://i.loli.net/2021/09/07/ncwJGzFQhj1uxvR.png)

图 AHB总线流水线操

### 4．APB总线

APB主要用于**低带宽的周边外设之间的连接，例如UART、定时器、并行IO接口**等。它的总线架构不像AHB支持多个主模块，**在APB里面唯一的主模块**就是与AHB总线相接的**APB桥**，因此也就**不需要仲裁器以及一些请求和授予信号**。APB协议十分简单，其特性包括：

- 两个时钟周期传输；
- 无需等待周期和回应信号；
- 控制逻辑简单，只有四个控制信号。

### 5．APB传输

APB上的传输可以用如图所示的状态图来说明。

<img src="https://i.loli.net/2021/09/07/LAcsEKRDoICZSqf.png" alt="image-20210907154810250" style="zoom:50%;" />

图 传输状态图

系统初始化为IDLE状态，此时没有传输操作，也没有选中任何从模块。

当有传输要进行时，PSELx=1, PENABLE=0，系统进入SETUP状态，而且只在SETUP状态停留一个周期。当PCLK的下一个上升沿到来时，系统进入ENABLE状态。

系统进入ENABLE状态后，维持之前在SETUP状态的PADDR、PSEL、PWRITE不变，并将PENABLE置为1。传输也只会在ENABLE状态维持一个周期，在经过SETUP与ENABLE状态之后传输已经完成。之后如果没有传输要进行，就进入IDLE状态等待；如果有连续的传输，则再进入SETUP状态。

### 6．APB桥

APB桥是在AMBA APB上**唯一的总线主模块**。另外，APB桥也是**在更高层次系统总线上的一个从模块**。桥单元**把系统总线传输转化为APB总线传输**，并执行下述功能：

- 锁存地址并在整个传输过程中保持其有效，直到数据传送完成。
- 地址译码并且生成一个外部选择信号PSELx，在一次传输期间只有一个选择信号有效。
- 写传送时**驱动数据到APB总线上**。
- 读传时**驱动APB数据到系统总线上**。
- 为传送触发使能信号PENABLE，使其有效。



## CoreConnect总线

CoreConnect总线是**IBM公司开发的工业标准总线**，与AMBA总线类似，CoreConnect总线也采用**总线分段**的方式，提供了三种基本总线类型，即：

* 处理器局部总线PLB（Processor Local Bus）
* 片上外围总线OPB（On-Chip Peripheral Bus）
* 设备控制总线DCR（Device Control Register），如图6-31所示。

PLB提供了一个高带宽、低延迟、高性能的处理器内部总线，最多可支持8个主模块，PLB的数据总线可以是32位、64位和128位，最大可扩展至256位。PLB总线采用完全同步的工作方式，数据总线和地址总线分离，支持可变或固定长度的成组传输、流水线作业和分离事务处理，支持DMA传送，支持重叠仲裁和可编程公平优先级算法，具有很高的带宽。

OPB总线也采用完全同步方式，总线宽度为32位地址总线和32位数据总线，支持主模块和从模块以及多个主模块间的数据传送。OPB与PLB通过OPB桥相连，OPB桥可以作为OPB或PLB上的主模块。OPB用于连接具有不同的总线宽度及时序要求的外设和内存。

DCR用于在CPU通用寄存器与设备控制寄存器之间传输数据，以减少PLB的负荷，增加其带宽。

<img src="https://i.loli.net/2021/09/07/9XsbKCfAqtZicu2.png" alt="image-20210907161125986" style="zoom:50%;" />

图 CoreConnect总线的体系结构

## WISHBONE总线

Wishbone总线规范是Silicore公司开发的一种供用户免费使用的开放式片上总线体系，**可应用于使用软核、固核和硬核的系统芯片的设计，对开发工具和目标硬件没有特殊要求，可以用多种硬件描述语言实现，并且几乎兼容所有的综合工具**。图6-32是Wishbone总线的体系结构。下图为Wishbone总线的体系结构。

<img src="C:\Users\杜瑶瑶\AppData\Roaming\Typora\typora-user-images\image-20210907225607389.png" alt="image-20210907225607389" style="zoom:50%;" />

**Wishbone总线采用的是主从构架**。对于各种IP核，其间并没有统一的连接方式。为了满足不同的系统的应用要求，Wishbone总线提供了四种不同的IP核的互连方式：点到点（point-point）连接、数据流（data flow）、共享总线（shared bus）和交叉开关（crossbar switch）。

* 点到点方式用于两个IP核之间的直接连接，两者之间通过握手信号进行通信控制。
* 数据流方式用于多个IP核之间的数据并发传输。
* 共享总线用于多个IP核共享一条总线，Wishbone总线支持多主设备的互连，并支持终端用户自定义的仲裁方法。
* 交叉开关可以同时连接多个主从部件，有利于提高系统的数据吞吐量。

Wishbone总线的多种互连方式为系统设计提供了很大的灵活性，并且大大简化了系统互连的接口逻辑。

Wishbone总线规范定义了最宽达64位的寻址空间，8-64位可扩展数据总线；支持单读/写周期、块传输周期、读-修改-写（read-modify-write）周期和事件（event）周期四种数据传输总线协议。
用户还可用两条Wishbone总线进行复杂系统的集成。
此外，Wishbone总线规范支持用户自定义信号，支持全局或部分地址编址的机制，支持用户自定义的仲裁机制。

## OCP总线

OCP总线是基于定义一套完整通用IP核插座接口标准的互连方案，通过定义IP核与对应接口模块之间点到点的接口信号协议，如数据信号、控制信号和测试信号等，来实现IP核的可重用、即插即用、认证及测试，以及不同IP核接口的集成。点到点的接口方式简单，且可完成数据的高速传输。对连接各接口模块的片内总线形式，OCP未作定义，由用户来扩展。下图为OCP总线系统的体系结构。

<img src="https://i.loli.net/2021/09/07/HAfwWZzQerCauVd.png" alt="image-20210907225019835" style="zoom:50%;" />