# 总线标准

通常，主板上的**“CPU—主存”总线**采用特定的**专用总线**。而用于连接各种I/O模块的I/O总线和底板式总线则可在不同的计算机中互用。实际上，**底板式总线和I/O总线通常是标准总线**，可用于不同厂家制造的不同的计算机系统。

大多数计算机允许用户很方便地插入设备，有的甚至是新开发的外围设备。**I/O总线**是扩充机器和连接新外设的一种常用手段。为了使机器的扩充和新设备的连接更加方便，计算机工业界已经开发出了各种**总线标准**，这些标准为计算机和外围设备制造商提供了一种规范，只要新机器按照规范去设计，外设就能用在其上面；同样地，只要新外设按照规范去实现，用户的计算机就能挂接它。有了总线标准，不同厂家可以按照同样的标准和规范生产各种不同功能的芯片、模块和整机，用户可以根据功能需求去选择不同厂家生产的、基于同种总线标准的模块和设备，甚至可以按照标准自行设计功能特殊的专用模块和设备，以组成所需的应用系统。这样可使芯片级、模块级、设备级等各级别的产品都具有兼容性和互换性，以使整个计算机系统的可维护性和可扩充性得到充分保证。

总线标准的形成有多种途径：

① 由于流行而自然形成的标准。有些机器如此流行以至于它们的I/O总线最终变成了事实上的标准。如IBM PC-AT总线。一旦一个总线标准被外设产品设计者大量使用，那么其他计算机制造商也会引入这种总线，并提供大量支持这种总线的外设。

② 为了解决共性问题而提出的一种标准。这种情况下，标准往往会由一个小组来制定。如SCSI总线和Ethernet就是由多个制造商合作提出的标准总线的例子。

③ 由标准化组织制定标准。如ANSI或IEEE等组织会提出一些总线标准。例如，PCI总线标准就是由Intel公司发起，后来由一个工业委员会制定并发展起来的。

## 标准总线规范

现在的标准总线规范越来越复杂。例如，PCI总线规范有282页之多，SCSI-2规范超过600页。所以，很多细节无法用几页纸说清楚。各种标准总线之间尽管在设计细节上有很多不同，并且各有特点，但从总体上看，无论哪种总线，**在其规范中都包含了信号系统、电气特性和机械物理特性等**。

而在信号系统的规定中，通常又包含信号分类、数据宽度、地址空间、传输速率、总线仲裁、握手协议、总线定时、事务类型等内容。所以本节只对典型的PCI总线和SCSI总线进行较为详细的介绍，对其他常用总线只做简单介绍，有关细节请参阅相关资料。

### 7.4.1 ISA总线

ISA（Industrial Standard Architecture）总线是IBM公司1984年为推出PC/AT机而建立的**系统总线标准**，所以也叫**AT总线**。它是在原先的PC/XT总线的基础上扩充而来的。它在推出后得到广大计算机同行的承认，兼容该标准的微型机大量出现。并且随后出现的286，386和486微机尽管工作频率各异，但大多采用ISA总线。

ISA总线的主要特点有：

① 它能支持64KB I/O地址空间、16MB主存地址空间的寻址，可进行8位或16位数据访问，支持15级硬中断、7级DMA通道。

② 它是一种简单的**多主控总线**。除了CPU外，DMA控制器、DRAM刷新控制器和带处理器的智能接口控制卡都可成为总线主控设备。

③ 它支持8种总线事务类型：存储器读、存储器写、I/O读、I/O写、中断响应、DMA响应、存储器刷新、总线仲裁。

它使用独立于CPU的总线时钟，因此CPU可以采用比总线频率更高的时钟。它的时钟频率为8MHz。ISA总线共有98根信号线，在原PC/XT总线62根线的基础上扩充了36根线，与原PC/XT总线完全兼容。它具有分立的数据线和地址线。数据线宽度为16位，可以进行8位或16位数据的传送，最大数据传输速率为16Mb/s。它提供两组地址信号线，即SA19～SA0和LA23～LA17，使用这两组地址信号线可以对16MB的主存地址空间和64KB的I/O地址空间进行访问。

### 7.4.2 EISA总线

EISA（Extended Industrial Standard Architecture）总线是一种在ISA总线基础上扩充的开放总线标准。**它从CPU中分离出了总线控制权**，是一种智能化的总线，**支持多总线主控和突发传输方式**。它的时钟频率为8.33MHz。EISA总线共有198根信号线，在原ISA总线的98根线的基础上扩充了100根线，与原ISA总线完全兼容。具有**分立的数据线和地址线**。数据线宽度为32位，具有8位、16位、32位数据传输能力，最大数据传输速率为33Mb/s。地址线的宽度为32位，所以寻址能力达232B。即CPU或DMA控制器等主控设备能够对4GB范围的主存地址空间进行访问。

### 7.4.5 SCSI总线

SCSI（Small Computer System Interface，小型计算机系统接口）总线从1984年开始广泛用在Macintosh机上，目前已普遍用在IBM PC兼容系统和许多工作站上。SCSI总线主要用于光驱、音频设备、扫描仪、打印机以及像硬盘驱动器这样的大容量存储设备的连接，是一种直接连接外设的并行I/O总线，挂接在SCSI总线上的设备以菊花链的方式相连。每个SCSI设备有两个连接器，一个用于输入，一个用于输出。若干设备连接在一起，一端用一个终端器连接，另一端通过一块SCSI卡连到主机上。例如，一块支持PCI总线标准的SCSI卡可直接插到PCI插槽中。SCSI设备的配置如图7.15所示。

图7.15 SCSI设备的配置

SCSI总线上的所有数据交换都是在请求方和目标方之间进行的。一般主机系统是请求方，外设是目标方。SCSI总线事务都按一定的顺序进行，依次经历以下8个总线阶段：

（1）总线空闲阶段。表示没有设备使用总线，总线可用。
（2）仲裁阶段。用来使一个设备获得总线使用权。
（3）选择阶段。用来让一个请求方选择一个目标设备来执行某个功能。
（4）重新选择阶段。允许目标设备重新连接请求方，以恢复原先由请求方启动而被目标方挂起的操作。例如，磁盘（带）进行寻道时，无需占据总线，此时磁盘等目标设备可以先释放总线，让出总线给其他设备，等到准备好读/写数据时，再进入重新选择阶段。一旦在发起者和目标之间建立了连接，则可进行信息传送。通常可以由发起者向目标设备发出命令，由目标设备向发起者回送状态，也可以在发起者和目标设备之间传送数据或消息。
（5）命令阶段。传送命令信息。使目标设备从请求方得到命令。
（6）数据阶段。目标设备请求数据传送。在该阶段可以进行数据输入（目标方到请求方）或数据输出（请求方到目标方）操作。
（7）状态阶段。目标设备向请求方发送状态信息。
（8）消息阶段。目标设备请求传送一个或多个消息。在该阶段可以进行消息输入（目标方到请求方）或消息输出（请求方到目标方）。
SCSI总线中各总线事务在正常情况下按顺序进行，当出现某种条件时，发起者和目标之间通过消息互换，引起总线阶段的转换。SCSI总线阶段状态转换如图7.16所示。

图7.16 SCSI总线阶段状态转换图

最早的SCSI规范SCSI-1只提供8位数据线，采用异步通信或5MHz的同步通信，最多允许7个设备以菊花链方式连接到主机上。1991年出版了修改后的规范SCSI-2，数据线可选择扩展到16位或32位，采用同步通信，时钟频率增加到10MHz，所以最大数据传输速率为20Mb/s或40Mb/s。1995年推出的SCSI-3的数据传输速率达60～120Mb/s。
SCSI-1规范规定了总线的信号系统共有50条信号线，采用50针扁平电缆或双绞线，称为SCSI A电缆。其中有9条数据线（8条数据线和一条奇偶校验信号线）和9条控制线，其余为地线或电源线。9根控制线如下：

（1）BSY——由使用总线的设备来设置，表示自己使总线处于忙状态。
（2）SEL——发起者选择目标时设置，或目标重新选择发起者时设置。
（3）C/D——目标用来标识数据线上是控制信息（命令、状态或消息）还是数据信息。
（4）I/O——目标用来标识数据传送的方向。
（5）MSG——目标用来标识正在向发起者传送的是消息。
（6）REQ——目标用来请求数据传送。此时，发起者将接收来自总线的数据（数据输入阶段），或把数据传送到总线（数据输出阶段）。
（7）ACK——发起者用来应答目标的REQ请求。表示正在进行相应的数据传送操作。
（8）ATN——发起者用来通知目标，它将有消息可传送。
（9）RST——使总线复位。
SCSI-2增加了24位数据线和相应的三个奇偶校验信号线，以及其他控制线和地线及电源线，因而SCSI-2在SCSI A电缆的基础上增加了68针B电缆。
在SCSI总线中，信息传送的类型有命令输出、数据输入、数据输出、状态输入、消息输入和消息输出。这些命令、数据、状态和消息都是通过数据线传输的。总线通过相应的控制线来区别数据线上传输的信息类型。其定义如表7.4所示。

表7.4 SCSI总线中各类信息传送阶段的定义

SCSI总线的裁决采用自举分布式方案。总线中的每个设备（一个主机和另外最多7个设备）都有一个唯一的标识号ID（0～7），这个标识号ID就是设备对应的优先级，7为最高，0为最低。需要使用总线的设备在仲裁阶段启动一根与该设备的ID对应的数据线，每个设备通过查看相关的数据线来确定是否将获得总线的使用权。
图7.17给出了一个常用的SCSI总线时序。它描述了从目标设备读取数据到发起设备的总线事务过程。



图7.17 SCSI总线时序举例



① 开始时，总线处于空闲状态。

② 仲裁阶段。要求使用总线的设备在相应的数据线上置请求信号。各设备通过查看有无优先级比自己高的设备的请求，确定自己是否能占用总线。一旦某设备获胜，则将成为发起者，通过启动SEL信号进入选择阶段。

③ 选择阶段。使自己和目标对应的数据线上ID有效，并在一定延迟后，使BSY信号无效。当目标检测到SEL信号有效，而BSY和I/O无效，并识别ID以后，它使BSY信号有效。当发起者检测到BSY信号时，释放数据线，并取消SEL信号。

④ 命令阶段。目标通过启动C/D线有效，表示已进入命令阶段。它使REQ信号有效，请求发起者传送命令的第一字节。发起者在送出第一字节后，使ACK有效。目标读入一字节后，取消REQ信号，然后发起者也取消ACK信号。命令的其他字节用同样的REQ/ACK握手信号来传送。

⑤ 数据输入（出）阶段。目标接收和解释命令后，取消C/D信号，便进入数据输入（出）阶段，数据传送的方向由信号I/O标识。通过REQ/ACK握手信号进行数据传送。

⑥ 状态阶段。目标使C/D信号有效，结束数据阶段而进入状态阶段（此时，I/O信号有效），通过REQ/ACK握手信号进行状态信息的输入。

⑦ 消息阶段。目标使MSG线有效，以进入消息阶段。正常情况下，会传送“命令完成”消息给发起者。发起者收到该消息后，就释放总线，使其空闲。

SCSI总线的通信定时方式，默认为异步方式，即每字节的传送都由REQ/ACK握手信号定时。也可设置为同步方式，仅用于数据输入阶段和数据输出阶段。通过“同步数据传送（SDTR）”消息来设置是否采用同步方式，如表7.5所示。

表7.5 SDTR消息的格式

采用同步方式时，要给出最小传输时间和最大REQ/ACK偏移值。最小传输时间是指为保证正确接收数据，前后两个REQ或ACK脉冲前沿之间相隔的最小时间间隔。最大REQ/ACK偏移值是指目标在接到相应的ACK以前允许发送的REQ脉冲的最大数。

### 7.4.6 EIA-232-D总线

一个广泛使用的串行总线标准是美国电子工业协会（EIA）于1987年制定的EIA-232-D标准，它的前身是EIA在1969年制定的推荐标准RS-232-C。它定义了按位串行传输的数据终端设备（DTE）和数据通信设备（DCE）之间的接口信息。当计算机和通信设备（如Modem和数字传真机）连接时，计算机的串行接口地位等同于数据终端设备。
EIA-232-D接口由25条信号线构成，其中有一条数据发送线，一条数据接收线，在接口对接时，这两条线交叉连接。为了数据的可靠传输，标准提供了以下几条控制线：

（1）请求发送RTS（Request To Send）。当发送方准备发送数据时，向对方发出一个RTS信号，以询问接收方是否准备好。

（2）允许发送CTS（Clear To Send）。当接收方收到发送方送来的RTS信号时，如果接收方已准备好接收数据，则向发送方回送一个CTS信号作为回答。

（3）数据终端准备好DTR（Data Terminal Ready）。接收方做好了接收数据的准备后，就主动向发送方发送一个DTR信号，以通知发送方进行数据发送。

（4）数据集就绪DSR（Data Set Ready）。发送方收到接收方发送来的DTR信号后，如果做好了发送准备，就向接收方送出一个DSR信号作为回答。

（5）载波检测CD（Carry Detect）。用于检测是否建立了连接。