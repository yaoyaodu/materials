# 输入/输出组织

输入/输出组织是**用来控制外设与内存或CPU之间进行数据交换的机构**，它是**计算机系统中重要的软、硬件结合的子系统**。

通常把**I/O设备**及其**接口线路**、**控制部件**、**通道或I/O处理器**及**I/O软件**统称为**输入/输出系统**。其要解决的问题是对各种形式的**信息进行输入/输出控制**。

实现输入/输出功能的关键是要解决以下一系列的问题：

① 如何在CPU、主存和外设之间建立一个高效的信息传输“通路”；

② 怎样**将用户的I/O请求转换成对设备的控制命令**；

③ 如何对外设进行编址；

④ 怎样使CPU方便地寻找到要访问的外设；

⑤ I/O硬件和I/O软件如何协调完成主机和外设之间的数据传送等。

围绕以上这些问题，重点介绍：

* I/O接口的功能和结构
* I/O设备的编址和寻址
* 在主机和外设间进行数据传送的各种输入/输出控制方式



## I/O接口

外部设备种类繁多，且具有不同的工作特性，因而它们在工作方式、数据格式和工作速度等方面存在很大差异。例如，键盘的数据格式是“位”；普通打印机的数据格式是“字节”；SCSI接口设备的数据格式可以是8，16或32位。

此外，由于CPU、内存等计算机主机部件采用高速元器件，使得它们和外设之间在技术特性上有很大的差异，它们各有自己的时钟和独立的时序控制，两者之间采用完全的异步工作方式，而且主机和外设在数据格式上也不尽相同。

为此，**在各个外设和主机之间必须要有相应的逻辑部件来解决它们之间的同步与协调、工作速度的匹配和数据格式的转换等问题，该逻辑部件就是I/O接口（I/O Interface）**。

从功能上来说，**PC机中**的各种**I/O控制器或设备控制器（包括适配器或适配卡）都是I/O接口**，而在**大型机中I/O模块**就是担负大量复杂的外设控制任务的**通道或I/O处理器**。

### 9.1.1 I/O接口的功能

**I/O接口是连接外设和主机的一个“桥梁”，因此它和外设侧、主机侧各有一个接口**。

通常把它和主机侧的接口称为**内部接口**，和外设侧的接口称为**外部接口**。内部接口通过**系统总线**和内存、CPU相连，而外部接口则通过各种**接口电缆**（如串行电缆、并行电缆、网线或SCSI电缆等）将其连到外设上。

因此，**通过I/O接口，可以在CPU、主存和外设之间建立一个高效的信息传输的“通路”**。

I/O接口的职能可概括为以下5个方面：

（1）**数据缓冲**。由于主存和CPU寄存器的存取速度非常快，而外设速度则较低，所以**在I/O接口中引入数据缓冲寄存器**，以达到主机和外设工作速度的匹配。

（2）**错误或状态检测**。提供**状态寄存器**，以保存各种状态信息（例如，设备是否完成打印或显示；是否已准备好输入数据以供主机来取；是否发生某种出错情况等）供CPU查用。接口和外设发生的出错情况有两类：一类是设备电路故障或异常情况；另一类是数据传输错，这种错误是通过在每个字符上采用一个奇偶校验位来检测的。

（3）**控制和定时**。提供控制和定时逻辑，以接收从系统总线来的控制和定时信号。在任何一段时间里，CPU根据程序中的I/O请求，选择相应的设备进行数据通信，要求一些**内部资源（如主存或寄存器、系统总线等）参与到I/O过程中**，这样I/O接口就必须提供定时和控制功能，以**协调内部资源与外设间动作的先后关系，控制数据通信过程**。

（4）**数据格式转换**。提供**数据格式转换部件**（如**进行“串—并”转换的移位寄存器**），使通过外部接口得到的数据转换为内部接口需要的格式，或在相反的方向进行数据格式转换。

（5）**与主机和设备通信**。上述功能都必须通过I/O接口与主机或与设备之间的通信来完成。

### 9.1.2 I/O接口的结构

不同的I/O接口在复杂性和控制外设的数量上相差很大，这里不可能一一列举，在此仅考察I/O接口的一般结构，即共性部分。下图给出了它的通用结构。

<img src="https://i.loli.net/2021/09/20/jUQhwniZdq38C9G.png" alt="image-20210920234510498" style="zoom:50%;" />

## I/O设备的寻址

I/O设备寻址是解决外设与主机通信的一个必要环节。I/O接口的引入给出了外设与主机进行信息交换的有效“通路”。但是仅有信息交换通路还不行，还必须提供一种手段，让CPU能方便地找到要进行信息交换的设备。为此，必须考虑：

① 怎样将用户的I/O请求转换成对设备的控制命令；

② 如何对外设进行编址；

③ 怎样使CPU方便地寻找到要访问的外设。

### 操作系统在I/O中的作用

现代计算机**I/O系统的复杂性一般都隐藏在操作系统中**，最终用户或用户程序只需通过一些简单的命令或系统调用就能使用各种I/O设备，而无需了解各种I/O设备的具体工作细节。

* 对于最终用户，操作系统通过命令行方式、批命令方式或图形界面方式为最终用户提供直接使用计算机资源的手段，**用户通过输入相应的命令或点击键盘和鼠标将I/O请求传送给操作系统**。

* 对于用户程序，操作系统提供一组关于**I/O的系统调用**（如打开文件、读/写文件、关闭文件等）。当用户程序需要从某个设备输入信息或将结果送到外设时，**通过系统调用（汇编语言）或库函数调用（高级语言），将I/O请求提交给操作系统**。

操作系统通常把I/O软件组织成从高到低的4个层次，层次越低越接近设备，而越远离用户程序。这4个层次依次为：

●用户层I/O软件；

●与设备无关的操作系统I/O软件；

●设备驱动程序；

●**I/O中断处理程序**。

用户层I/O软件：

大部分I/O软件都属于操作系统，但最初的I/O请求是在用户程序中提出来的。通常把**提出I/O请求的用户程序**看成是**用户层I/O软件**。例如，C语言用户程序中的printf函数、scanf函数等都是一种I/O请求。标准I/O库中包含了大量的涉及I/O的库例程。它们在用户程序中作为其中的一部分运行。

操作系统中与设备无关的I/O软件：

其基本功能是执行适用于所有设备的常用I/O功能，向用户层软件提供一个统一的调用接口。

设备驱动程序：

设备驱动程序是与设备相关的I/O软件部分。每个设备驱动程序只处理一种设备或一类紧密相关的设备。**每个设备都有一个相关的设备接口（通常称为设备控制器）**，其中有各种**控制寄存器、状态寄存器和数据缓冲寄存器**，**设备驱动程序通过对这些寄存器进行编程，将相应的命令送控制寄存器，读取状态寄存器中的状态，从数据缓冲寄存器中获取或发送数据等**。

例如，对于磁盘而言，磁盘驱动程序知道磁盘控制器有多少寄存器、每个寄存器的用途及进行磁盘操作所必须的全部参数，包括磁头定位时间、磁盘旋转时间、磁头数、磁道数、扇区数、交错因子等。一个用户的I/O请求，通过操作系统最终传递给设备驱动程序。所以真正的I/O执行是由设备驱动程序完成的。例如，在对磁盘的操作中，磁盘驱动程序将完成：计算出请求块的物理地址，检查磁盘驱动器的电机是否运转，检测磁头是否定位在正确的柱面上等工作。

当设备驱动程序启动外设进行某种操作时，一种方式是等待外设完成相应的操作，这种方式效率很低；更有效的方式是，主机向外设发出某个命令以后，转去执行其他程序，而当外设完成相应命令时，用中断方式通知操作系统。此时调出相应的中断处理程序来对“外设完成任务”的事件进行处理。

操作系统必须保证一个用户程序只能访问到该用户有权限的I/O设备部分。例如，如果文件的所有者没有给一个用户程序以访问的权限，那么操作系统则不允许该程序读或写磁盘上的这个文件。**在一个具有共享I/O设备的系统中，如果用户程序能够直接执行I/O，则无法提供保护功能。这也是用户程序必须通过操作系统来使用外设的一个原因。**

为了使操作系统能够直接和I/O设备进行通信，并阻止用户程序直接访问I/O设备，必须提供以下三种信息的通信：

（1）操作系统必须能向I/O设备发出命令，这些命令不仅包含读/写等操作，而且包括对设备本身的一些操作，如磁盘查找、定位等。
（2）当I/O设备已经完成一个操作或遇到一个错误时，设备必须能够通知操作系统，以便进行适当处理。例如，当磁盘完成一次定位后，它要能通知操作系统。
（3）数据必须在存储器或CPU寄存器和I/O设备之间传输。

在以上信息的通信过程中，操作系统是通过执行相应程序中的一条条指令来完成的。因此在进行指令系统设计时，必须考虑提供某种能对I/O进行访问的指令。

### I/O端口的编址

系统是如何在I/O的指令中标识要访问的I/O接口中的某个寄存器呢？这就是I/O端口编址问题。**I/O端口实际上就是I/O接口中的各种寄存器**，如数据缓存寄存器、控制状态寄存器。一个I/O端口可能是输入端口、输出端口，或者是双向的既可输入也可输出的端口。有些I/O端口用来存放数据，如串行接口中的发送和接收寄存器；还有些I/O端口用来控制外设，如磁盘控制器中的控制寄存器。对这些端口地址的写或读就认为是向I/O设备送出命令或从设备取得数据。

为了便于CPU对I/O设备的快速选择和对I/O端口的方便寻址，**必须给所有的I/O接口中的各个可访问的寄存器进行编址**，一般采用以下两种方式之一对I/O端口进行编址。

（1）独立编址方式。对所有的I/O端口单独进行编号，使它们成为一个独立的I/O地址空间。需要用专门的输入/输出指令来访问I/O端口。输入/输出指令中地址码部分给出I/O端口号。

（2）统一编址方式。**与主存地址空间统一编址，即将主存地址空间分出一部分地址给I/O端口进行编号。**无需设置专门的输入/输出指令，只要用一般的访存指令就可以存取I/O端口。因为**这种方法是将I/O端口映射到主存空间的某个地址上，所以也被称为“存储映射I/O方式”。**例如，Motorola公司生产的处理器就采用该方案。



## I/O数据传送控制方式

通常把I/O数据传送控制方式分为以下四种：

### 1．程序直接控制方式

直接通过程序来控制主机和外设的数据交换。在程序中安排相应的I/O指令，通过这些指令直接向I/O接口传送控制命令，从I/O接口中取得外设和接口的状态，并根据状态来控制外设和主机的信息交换。

### 2．程序中断控制方式

程序中断控制方式的基本思想是，当CPU需要进行输入/输出时，先执行相应的I/O指令，将启动命令发送给相应的I/O接口和外设，然后CPU继续执行其他程序。I/O接口接收到CPU送过来的命令后，就开始启动外设进行相应的操作，当外设和I/O接口完成CPU交给的任务后，I/O接口便向CPU发中断请求。CPU响应后，中止正在执行的程序，转入一个“中断服务程序”。在“中断服务程序”中完成数据传送任务，传送完毕再回到被中断的原程序处继续执行。一般在这种方式下，每次只能交换一字节或一个字。

### 3．直接存储器存取方式

直接存储器存取（Direct Memory Access）方式简称DMA方式，主要用于**高速设备（如磁盘、磁带等）和主机的数据传送**。这类高速设备采用**成批数据交换方式，且单位数据之间的时间间隔较短**。

DMA方式的基本思想是，**在外设和主存之间直接进行数据传送，用一个专门的硬件（DMA控制器）来控制总线进行数据交换**。在进行DMA传送时，**CPU让出总线控制权，由DMA控制器控制总线**。DMA控制器通过“窃取”一个主存周期完成和主存之间的一次数据交换，或独占若干主存周期完成一批数据的交换。

### 4．通道和I/O处理器方式

**一般微型机采用前面三种方式。对于大型计算机系统来说**，为了获得CPU和外设之间更高的并行性，也为了让种类繁多、物理特性各异的外设能以标准的接口连接到系统中，**通常采用自成独立体系的通道结构或I/O处理器**。在它进行主存和外设之间的信息传送时，CPU执行自己的程序，两者完全并行。

在大型计算机系统中，外围设备的数量、种类较多，为了在处理I/O请求时进一步减少中断处理次数和处理器的占用时间，通常**把对外设的管理和控制工作从CPU中分离出来，使I/O控制器更具智能化**，这种**I/O控制器**称为**通道控制器或I/O处理器**。

**通道控制器和I/O处理器可以独立地执行一系列的I/O操作**，这些I/O操作序列通常被称为**I/O通道程序**，这些程序可能被存储在I/O处理器自己的存储器，或在共享的主存中，由I/O处理器从主存中取出执行。当CPU执行I/O请求时，操作系统要为I/O读/写操作组织相应的传送参数或I/O通道程序，通道或I/O处理器通过I/O通道程序执行相应的操作，只有当整个程序都执行完毕，才会中断CPU。



## 外部接口

外部接口是指I/O模块中与外设侧的接口。对于一般的设备来说，它总是通过某种电缆插接到相应的外设控制器上，这个电缆和设备控制器之间的接口，就是**外部接口**。通常我们称某个设备插在并口、串口、SCSI接口、USB接口上等，这里的并口、串口、SCSI接口、USB接口等都是I/O接口在外设侧的一种接插标准。

对于I/O接口中的**内部接口**，数据在接口和主机之间**总是通过系统总线按字节、字或多字进行并行传输**。而在**外部接口**中数据在接口和外设之间有**串行和并行两种传送方式**。所以按数据传送方式来分，**外部接口可分为并行接口和串行接口两种**。

- 并行接口在设备和接口之间同时传送一字节或一个字的所有位，如Intel 8255A，SCSI等。
- 串行接口在设备和接口之间一位一位地传送数据，如Ins8250，USB，P1394等。



