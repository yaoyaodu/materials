# 输入/输出组织

要点：

- 如何组织I/O设备与主机之间的数据交互。
- I/O接口的结构、功能与分类。
- I/O数据传输的多种控制方式：
  - 程序直接控制
  - 中断
  - DMA
  - 通道和I/O处理机

输入/输出组织是**用来控制外设与内存或CPU之间进行数据交换的机构**，它是**计算机系统中重要的软、硬件结合的子系统**。

通常把**I/O设备**及其**接口线路**、**控制部件**、**通道或I/O处理器**及**I/O软件**统称为**输入/输出系统**。其要解决的问题是对各种形式的**信息进行输入/输出控制**。

实现输入/输出功能的关键是要解决以下一系列的问题：

① 如何在CPU、主存和外设之间建立一个高效的信息传输“通路”；

② 怎样**将用户的I/O请求转换成对设备的控制命令**；

③ 如何对外设进行编址；

④ 怎样使CPU方便地寻找到要访问的外设；

⑤ I/O硬件和I/O软件如何协调完成主机和外设之间的数据传送等。



本章将围绕以上这些问题，重点介绍：

* I/O接口的功能和结构
* I/O设备的编址和寻址
* 在主机和外设间进行数据传送的各种输入/输出控制方式



## 9.1 I/O接口

外部设备种类繁多，且具有不同的工作特性，因而它们在工作方式、数据格式和工作速度等方面存在很大差异。例如，键盘的数据格式是“位”；普通打印机的数据格式是“字节”；SCSI接口设备的数据格式可以是8，16或32位。

此外，由于CPU、内存等计算机主机部件采用高速元器件，使得它们和外设之间在技术特性上有很大的差异，它们各有自己的时钟和独立的时序控制，两者之间采用完全的异步工作方式，而且主机和外设在数据格式上也不尽相同。

为此，**在各个外设和主机之间必须要有相应的逻辑部件来解决它们之间的同步与协调、工作速度的匹配和数据格式的转换等问题，该逻辑部件就是I/O接口（I/O Interface）**。

从功能上来说，**PC机中**的各种**I/O控制器或设备控制器（包括适配器或适配卡）都是I/O接口**，而在**大型机中I/O模块**就是担负大量复杂的外设控制任务的**通道或I/O处理器**。

### 9.1.1 I/O接口的功能

**I/O接口是连接外设和主机的一个“桥梁”，因此它和外设侧、主机侧各有一个接口**。

通常把它和主机侧的接口称为**内部接口**，和外设侧的接口称为**外部接口**。内部接口通过**系统总线**和内存、CPU相连，而外部接口则通过各种**接口电缆**（如串行电缆、并行电缆、网线或SCSI电缆等）将其连到外设上。

因此，**通过I/O接口，可以在CPU、主存和外设之间建立一个高效的信息传输的“通路”**。

I/O接口的职能可概括为以下5个方面：

（1）**数据缓冲**。由于主存和CPU寄存器的存取速度非常快，而外设速度则较低，所以**在I/O接口中引入数据缓冲寄存器**，以达到主机和外设工作速度的匹配。

（2）错误或状态检测。提供**状态寄存器**，以保存各种状态信息（例如，设备是否完成打印或显示；是否已准备好输入数据以供主机来取；是否发生某种出错情况等）供CPU查用。接口和外设发生的出错情况有两类：一类是设备电路故障或异常情况；另一类是数据传输错，这种错误是通过在每个字符上采用一个奇偶校验位来检测的。

（3）控制和定时。提供控制和定时逻辑，以接收从系统总线来的控制和定时信号。在任何一段时间里，CPU根据程序中的I/O请求，选择相应的设备进行数据通信，要求一些内部资源（如主存或寄存器、系统总线等）参与到I/O过程中，这样I/O接口就必须提供定时和控制功能，以协调内部资源与外设间动作的先后关系，控制数据通信过程。

（4）数据格式转换。提供数据格式转换部件（如进行“串—并”转换的移位寄存器），使通过外部接口得到的数据转换为内部接口需要的格式，或在相反的方向进行数据格式转换。

（5）与主机和设备通信。上述功能都必须通过I/O接口与主机或与设备之间的通信来完成。

### 9.1.2 I/O接口的结构

不同的I/O接口在复杂性和控制外设的数量上相差很大，这里不可能一一列举，在此仅考察I/O接口的一般结构，即共性部分。下图给出了它的通用结构。

<img src="https://i.loli.net/2021/09/20/jUQhwniZdq38C9G.png" alt="image-20210920234510498" style="zoom:50%;" />

## 9.2 I/O设备的寻址

I/O设备寻址是解决外设与主机通信的一个必要环节。I/O接口的引入给出了外设与主机进行信息交换的有效“通路”。但是仅有信息交换通路还不行，还必须提供一种手段，让CPU能方便地找到要进行信息交换的设备。为此，必须考虑：

① 怎样将用户的I/O请求转换成对设备的控制命令；

② 如何对外设进行编址；

③ 怎样使CPU方便地寻找到要访问的外设。

==9.2.1 操作系统在I/O中的作用==

==9.2.2 I/O端口的编址==

## 9.3 I/O数据传送控制方式

### 9.3.1 I/O数据传送控制方式的类型

通常把I/O数据传送控制方式分为以下四种：

1．程序直接控制方式

直接通过程序来控制主机和外设的数据交换。在程序中安排相应的I/O指令，通过这些指令直接向I/O接口传送控制命令，从I/O接口中取得外设和接口的状态，并根据状态来控制外设和主机的信息交换。

2．程序中断控制方式

程序中断控制方式的基本思想是，当CPU需要进行输入/输出时，先执行相应的I/O指令，将启动命令发送给相应的I/O接口和外设，然后CPU继续执行其他程序。I/O接口接收到CPU送过来的命令后，就开始启动外设进行相应的操作，当外设和I/O接口完成CPU交给的任务后，I/O接口便向CPU发中断请求。CPU响应后，中止正在执行的程序，转入一个“中断服务程序”。在“中断服务程序”中完成数据传送任务，传送完毕再回到被中断的原程序处继续执行。一般在这种方式下，每次只能交换一字节或一个字。

3．直接存储器存取方式

直接存储器存取（Direct Memory Access）方式简称DMA方式，主要用于**高速设备（如磁盘、磁带等）和主机的数据传送**。这类高速设备采用**成批数据交换方式，且单位数据之间的时间间隔较短**。

DMA方式的基本思想是，**在外设和主存之间直接进行数据传送，用一个专门的硬件（DMA控制器）来控制总线进行数据交换**。在进行DMA传送时，**CPU让出总线控制权，由DMA控制器控制总线**。DMA控制器通过“窃取”一个主存周期完成和主存之间的一次数据交换，或独占若干主存周期完成一批数据的交换。

4．通道和I/O处理器方式

**一般微型机采用前面三种方式。对于大型计算机系统来说**，为了获得CPU和外设之间更高的并行性，也为了让种类繁多、物理特性各异的外设能以标准的接口连接到系统中，**通常采用自成独立体系的通道结构或I/O处理器**。在它进行主存和外设之间的信息传送时，CPU执行自己的程序，两者完全并行。

### 9.3.5 通道和I/O处理器方式

在大型计算机系统中，外围设备的数量、种类较多，为了在处理I/O请求时进一步减少中断处理次数和处理器的占用时间，通常**把对外设的管理和控制工作从CPU中分离出来，使I/O控制器更具智能化**，这种**I/O控制器**称为**通道控制器或I/O处理器**。

**通道控制器和I/O处理器可以独立地执行一系列的I/O操作**，这些I/O操作序列通常被称为**I/O通道程序**，这些程序可能被存储在I/O处理器自己的存储器，或在共享的主存中，由I/O处理器从主存中取出执行。当CPU执行I/O请求时，操作系统要为I/O读/写操作组织相应的传送参数或I/O通道程序，通道或I/O处理器通过I/O通道程序执行相应的操作，只有当整个程序都执行完毕，才会中断CPU。



## 9.4 外部接口

外部接口是指I/O模块中与外设侧的接口。对于一般的设备来说，它总是通过某种电缆插接到相应的外设控制器上，这个电缆和设备控制器之间的接口，就是**外部接口**。通常我们称某个设备插在并口、串口、SCSI接口、USB接口上等，这里的并口、串口、SCSI接口、USB接口等都是I/O接口在外设侧的一种接插标准。

对于I/O接口中的**内部接口**，数据在接口和主机之间**总是通过系统总线按字节、字或多字进行并行传输**。而在**外部接口**中数据在接口和外设之间有**串行和并行两种传送方式**。所以按数据传送方式来分，**外部接口可分为并行接口和串行接口两种**。

- 并行接口在设备和接口之间同时传送一字节或一个字的所有位，如Intel 8255A，SCSI等。
- 串行接口在设备和接口之间一位一位地传送数据，如Ins8250，USB，P1394等。



