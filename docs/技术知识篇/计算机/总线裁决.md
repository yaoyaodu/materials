# 总线裁决

要点：

- 总线主控设备（如处理器）和从设备（如存储器）
- **总线裁决**：决定**哪个总线主控设备将在下次得到总线使用权**的过程
- 集中式总线裁决和分布式总线裁决

## 概述

总线设计中的一个重要问题是，**一个希望进行通信的设备如何获取总线使用权**？

为什么总线设计方案中要给出如何控制总线使用权的问题呢？因为**总线是被连接在其上的所有设备共享的，所以需要一个协议来表明哪个设备将可以使用总线**。如果没有任何控制，那么当多个设备需要通信时，每个设备都试图为各自的传输而将信号送到总线上，这样就会产生混乱。

这种混乱可以通过**在系统中引入一个或多个总线主控设备**来避免。总线上连接的各个部件，**根据其对总线有无控制能力**被分为**主控设备和从设备**两种。

* 主控设备控制对总线的访问，它能够发起并控制所有总线请求。
* 从设备只能响应从主控设备发来的总线命令。

例如，处理器一定能发起一个对存储器的总线请求，所以它总是一个总线主控设备，存储器总是一个从设备，因为它将响应读/写请求，但它不会产生请求。

* **最简单的系统可以只有一个总线主控设备—处理器**。**在一个单主控设备系统中，所有总线操作都必须由处理器控制，所以无需总线裁决**。这种方式的主要**缺点是，处理器必须介入到每个总线事务中**。例如，从磁盘读一个扇区的工作可能会要求处理器介入成千上万次，根据每次传送的数据块大小的不同，介入次数有所不同。因为设备已经变得很快，并且能够以更高带宽进行传送，所以**处理器的负担越来越重**。因此，使处理器介入到每个总线事务中的做法已越来越没有吸引力了。

* 另一种选择是采用**多个总线主控设备，每个主控设备都能启动数据传送**。如果允许在教室中几个人都讲话而不需要教师介入，就**必须有一个协议来决定下次该谁得到话语权**。同样地，对于多主控设备总线，也**必须提供一种机制来决定在某个时刻哪个设备具有总线使用权**。

决定**哪个总线主控设备将在下次得到总线使用权**的过程称为**总线裁决**。进行总线裁决有多种方案。从大的方面来讲，有两类**总线裁决方式：集中式和分布式**。

* 集中式：将**控制逻辑**做在一个**专门的总线控制器或总线裁决器**中，它**将所有的总线请求集中**起来，利用一个特定的**裁决算法**进行裁决。

* 分布式：没有专门的总线控制器，其**控制逻辑分散在各个部件或设备中**。

在一个总线裁决方案中，主控设备使用总线请求信号进行总线请求，获得总线控制权后，设备就可以使用总线了。根据不同的**总线释放机制**在一种特定的事件发生后，就向裁决器发出信号表示不再需要总线，此时裁决器就能保证让总线分配给另一个设备。

大多数具有多个主控设备的总线都有一组连线来传送总线请求和接收许可信号。有时用于总线裁决的信号线在物理上是单独的，而在另外一些总线中则采用信号线复用的方式，用数据线进行总线请求，这种情况下，总线裁决和数据传输不能重叠进行。

在选择哪个设备获得总线使用权时，一般的裁决方案通常试图平衡两个因素：

* 第一个是**“等级性”**，即每个主控设备有一个**总线优先级**，具有最高优先级的设备应该先被服务。

* 第二个是**“公平性”**，即任何设备，即使是具有最低优先权的设备也不能永远得不到总线使用权。这种“公平性”保证了想使用总线的每个设备最终总能得到总线使用权。

除了上述因素外，更复杂的方案应考虑怎样**缩短总线裁决时间**。因为裁决时间的开销，增加了响应时间和总线访问时间，因而应该尽量缩短裁决时间并尽可能与总线传送操作在时间上重叠。

## 集中裁决方式

常用的集中裁决方式有以下三种。

（1）菊花链查询方式

在菊花链查询方式中，**优先级由主控设备在总线上的位置来决定**，要求**拥有总线使用权的高优先级设备简单地拦截总线允许信号**，不让优先级更低的设备收到该信号。

菊花链查询方式如图7.1所示。图中控**制线中有三根线用于总线控制（BS—总线忙、BR—总线请求、BG—总线允许）**，总线允许线从最高优先权的设备依次向最低优先权的设备串行相连。如果BG到达的设备有总线请求，BG信号就不再往下传，该设备建立总线忙BS信号，表示它已获得了总线使用权，占用了总线。

菊花链查询方式的优点是简单，只需很少几根线就能按一定优先次序实现总线裁决，而且易扩充设备。缺点是不能保证公正性，即一个低优先级请求可能永远得不到允许，而且对电路故障较敏感，一个设备的故障会影响到后面设备的操作。另外，菊花链的使用也限制了总线速度。

<img src="https://i.loli.net/2021/09/25/1OF6quHhnMidNST.png" alt="image-20210925165339435" style="zoom:50%;" />

图7.1 菊花链查询方式

（2）计数器定时查询方式

计数器定时查询方式比菊花链查询方式**多了一组设备线，少了一根总线允许线BG**，如图7.2所示。

总线控制器接收到BR送来的总线请求信号后，在总线未被使用（BS=0）的情况下，由计数器开始计数，并将计数值通过设备线向各设备发出。当某个有总线请求的设备号与计数值一致时，该设备便获得总线使用权，此时终止计数查询，同时该设备建立总线忙BS信号。计数器的初始值可由程序来设置，因而设备的优先级可以通过设置不同的计数初始值来改变。若每次计数总是从0开始，此时设备的优先次序是固定的；若每次计数的初始值总是上次得到控制权的设备的设备号，那么所有设备的优先级就是相等的，是一种循环优先级方式。计数器定时查询方式除了具有灵活的优先级优点外，它对电路故障也不如菊花链查询方式那样敏感。但这种方式增加了一组设备线，并且每个设备要对设备线的信号进行译码处理，因而其控制也变复杂了。

<img src="https://i.loli.net/2021/09/25/fKI7NxP5ioyVwFD.png" alt="image-20210925165446774" style="zoom:50%;" />

图7.2 计数器定时查询方式

（3）独立请求方式

独立请求方式使用一个中心裁决器从请求总线的一组设备中选择一个，其结构如图7.3所示。

从图中可见，每个设备都有一对总线请求线BRi和总线允许线BGi。各个设备独立地请求总线。当某个设备要求使用总线时，就通过其对应的总线请求线将请求信号送到总线控制器。总线控制器中有一个判优电路，可根据各个设备的优先级确定选择哪个设备使用总线。控制器可以给各个请求线以固定的优先级，也可以设置可编程的优先级。这种方法的优点是，响应速度快，如果是可编程的总线控制器，那么优先级还可以灵活设置。但它的控制逻辑很复杂，控制线数量多。

<img src="https://i.loli.net/2021/09/25/oMKt4wZq6Xay1BG.png" alt="image-20210925165538215" style="zoom:50%;" />

图7.3 独立请求方式



**独立请求方式中的裁决算法在总线控制器中由硬件来实现**，可以采用固定的并行判优算法、平等的循环菊花链算法、动态优先级算法（如最近最少用算法、先来先服务算法）等。

若n表示允许挂接的最大设备数，则菊花链查询方式只需两根裁决线，计数器定时查询方式大致需用log2n根裁决线，而独立请求方式则需用2n根裁决线。

有些总线系统将查询方式和独立请求方式结合起来。例如，VME总线使用了多个菊花链，每个菊花链具有一对独立的请求线和允许线，一个并行判优的优先权编码器从多个请求线中选择。

## 分布式裁决方式

常用的分布式裁决方式有以下三种。

（1）自举分布式裁决

自举分布式裁决方案也使用多个请求线，不需要中心裁决器，每个设备独立地决定自己是否是最高优先级请求者。一般优先级是固定的，每个需要请求总线控制权的设备在各自对应的总线请求线上送出请求信号，在总线裁决期间每个设备将有关请求线上的信号合成后取回分析，根据这些请求信号确定自己能否拥有总线控制权。每个设备通过取回的合成信息能够检测出其他设备是否发出了总线请求。如果没有，则可以立即使用总线，并通过总线忙信号阻止其他设备使用总线。如果一个设备在发出总线请求的同时，检测到其他优先级更高的设备也请求使用总线，则本设备不立即使用总线；否则，本设备就可立即使用总线。

图7.4是自举分布式裁决的示意图，假定总线上有4个设备，每个设备有一个唯一的标识号i（从0～3），其中设备0的优先级最低，设备3的优先级最高。BR0为总线忙信号线，BRi （i从1～3）为设备i的总线请求线。这样，设备0在确认BR0上无有效信号（即总线空闲），同时BR1，BR2和BR3上没有其他设备发出的请求信号时，就可使用总线了。它将BR0信号线置为有效，表示总线处于忙状态。设备1在确认总线空闲，并且BR2和BR3上没有请求信号时能使用总线。设备2在确认总线空闲且BR3上没有请求信号时就能使用总线。而设备3则在总线空闲时可直接使用总线。由上述过程来看，最低优先级的设备0可以不需要总线请求线。因为没有其他设备需要它的请求信号。这种方案需要较多的连线用于请求信号，所以许多总线用数据线DB作为总线请求线。例如，NuBus是在Macintosh Ⅱ机中的底板式总线，它就采用该方案，SCSI总线也采用该方案。

<img src="https://i.loli.net/2021/09/25/TeA51yHP3EILR9D.png" alt="image-20210925165623883" style="zoom:50%;" />

图7.4 自举分布式裁决

（2）冲突检测分布式裁决

在冲突检测分布式裁决方案中，每个设备独立地请求总线，多个同时使用总线的设备会产生冲突，这时冲突被检测到，按照某种策略在冲突的各方选择一个设备。例如，以太网（Ethernet）使用以下方案进行总线裁决：当某个设备要使用总线时，首先检查是否有其他设备正在使用总线，如果没有，它就置总线忙，然后使用总线；若两个设备同时检测到总线空闲，那它们可能会立即使用总线，此时，便发生了冲突。一个设备在传输过程中，它会侦听总线以检测是否发生了冲突，当冲突发生时，两个设备都会停止传输，延迟一个随机时间后再重新使用总线。就像两个有礼貌的人发现自己和对方同时走上一个独木桥后，两人又都同时退回一样，过一个随机时间段后，就可能有一人先走，这样冲突就解决了。这种方案一般用在网络通信总线上。

（3）并行竞争分布式裁决

并行竞争分布式裁决是一种较复杂但很有效的裁决方案。其基本思想是，总线上的每个设备都有一个唯一的仲裁号，需要使用总线的主控设备把自己的仲裁号发送到仲裁线上，这个仲裁号将用在并行竞争算法中。每个设备根据算法决定在一定时间以后占用总线还是撤销仲裁号。

并行竞争机制是这样的。假定总线有8根仲裁线AB0～AB7，需要使用总线的主控设备把自己的仲裁号发送到这8根仲裁线上，发送最大仲裁号的设备将获得总线使用权。

每个设备中的裁决逻辑如图7.5所示，设备和总线采用相反的逻辑，设备中的电路采用正逻辑，而总线则采用负逻辑。

每个设备把它的仲裁号cn0～cn7放到仲裁线AB0～AB7上，任何一根特定仲裁线的信号都是所有送到那条线的信号的“或”，所以只要有一个设备把逻辑“1”送到这个特定的仲裁线上，那么这根线的信号就是“1”，即信号线为低电平。每个设备的裁决逻辑将检测裁决线上的结果值，并根据下列规则修改它放到总线上的仲裁号：如果该设备的仲裁号中有某一位为0，而这一位对应的仲裁线信号为“1”，则修改这个仲裁号，使其所有低位都从总线上撤销，也即让所有低位对应的仲裁线送出一个为“0”的信号。这样，具有最高仲裁号的设备将会发现它的仲裁号和留在仲裁线上的号匹配，所以它将赢得总线使用权。

举例：下面用一个例子来说明裁决逻辑的工作原理。

假定总线上同时有两个设备要求使用总线，它们的仲裁号分别是00000101和00001010。对裁决逻辑电路进行分析，可以得出表7.1所示的结果。由此可见，最终留在仲裁线上的号为00001010，即仲裁号大的那个设备将赢得总线使用权。

<img src="https://i.loli.net/2021/09/25/dUkKq9rf6msGIXP.png" alt="image-20210925165743605" style="zoom:50%;" />

图7.5 并行竞争分布式裁决逻辑

表7.1 并行竞争裁决逻辑举例分析结果

<img src="https://i.loli.net/2021/09/25/WgNXzyJjsHVarEF.png" alt="image-20210925165733316" style="zoom:50%;" />

这种方式与自举分布式裁决算法相比，它可以用很少的裁决线挂接大量的设备。例如，假定是8位仲裁号，自举分布式裁决只能表示8个优先级，而这种方式可以表示256个优先级，仲裁号为255的设备优先级最高，而0最低。例如，Futurebus+总线标准使用这种裁决方案。

不同裁决方案的适应性由不同的因素来确定。这些因素包括：总线在I/O设备的数量和总线长度的可扩充性如何，总线裁决应该多快，需要何种程度的公正性等。