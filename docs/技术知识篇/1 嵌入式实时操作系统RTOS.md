# 嵌入式实时操作系统RTOS 

## 6.6.1 实时操作系统

计算机的应用有**实时应用**和**非实时应用**两类。

在实时应用场合，**要求计算机在确定的时间内执行其功能并对外部的异步事件作出响应**，能够满足上述要求的计算机系统称为实时系统。

实时系统操作的正确性不仅依赖于逻辑设计的正确性，而且取决于这些操作进行的时间。

例如，一个视频播放系统要求从CDROM中读取经压缩的数据，将其解压后送到显示设备。如果显示设备的帧频为50Hz，则每帧画面的保留时间为20ms，那么该视频播放系统必须在20ms内将下一帧从CDROM中读出并完成解压。20ms就成为一个时间限制，每次处理均在20ms内就是实时，一万次处理中有一次处理时间大于20ms，也会引起画面质量的下降，就不是一个好的实时系统。

实时系统通常又有**硬实时系统**和**软实时系统**之区分。前者意味着存在必须满足的时间限制，如前述的视频播放系统。后者意味着偶尔超过时间限制是可以容忍的，例如实时数据库查询系统在用户键入请求后几秒内得到查询结果，偶尔一次超时并不影响系统的使用。

实时操作系统（Real Time Operational System, RTOS）是基于计算机的，是**管理计算机硬件资源并提供人机交互和编程接口的系统**，实时操作系统能**在固定的时间内对一个或多个外设发出的信号作出适当的反应**。与**普通（分时）操作系统**不同，实时操作系统**强调了系统对外部异步事件响应时间的确定性**。

操作系统是整个计算机系统的重要组成部分，负责整个计算机系统中的文件管理（或外存管理）、内存管理、任务管理（或进程管理）和I/O管理。经过几十年的发展，计算机操作系统已十分成熟。**实时操作系统充分利用计算机操作系统的发展成果，在此基础上，调整中断处理的优先级，使系统对外部事件的响应速度小于某个特定的时间，从而构成了实时系统。**

目前应用比较广泛的实时操作系统有Linux, OS/9, VxWorks, μC/OS等，其中Linux和μC/OS是源码开放的免费实时操作系统，故应用较广。这些实时操作系统具有如下特点：

●规模小；
●中断被屏数的时间短；
●中断处理时间短；
●任务切换快。

6.6.2 嵌入式实时操作系统

在嵌入式系统和SOC中，系统软件可以用汇编程序编写，而不使用RTOS，这种方式称为**前后台系统**。编写应用程序时先顺着一条线画好流程图，然后按照流程图编写程序。

嵌入式**应用程序**一般是一个**无限循环，循环中调用相应的函数完成相应的操作**，这部分操作可以看成是**后台行为**。

**用中断来处理随机事件**，这部分可看成是**前台行为**。

这样就构成了前后台系统。

**前台称为中断级，后台称为任务级**。

后台程序逐个检查每个任务是否具备了运行条件，逐个完成相应的操作。时间要求苛刻的操作依靠中断完成。中断服务程序中置位一个事件发生了的标志，然后退出中断，待后台程序运行到检查这个标志的时候，才能完成事件处理，再将事件发生标志复位。如果在中断服务中加入事件处理程序，则中断服务程序将会变得太长，影响后来的中断或其他中断。

前台系统在处理信息的及时性上比实际可以做到的要差，采取适当的方法，有可能做得更快一些。这个反映及时性的指示叫做任务级响应时间。在最坏的情况下，任务级响应时间取决于整个后台循环执行的时间。由于后台程序循环一次的执行时间不是常数，程序经过某一点的准确时间是不确定的，若程序作了修改，循环时间也会受到影响。此外，这种单任务程序的另一个缺点是，一旦这条线的任何一处因某种意外被破坏了，则整个系统就会“死机”。但这类系统的优点是简单，不需要RTOS，也没有RAM/ROM的额外开销，在程序比较简单的系统中仍被广泛采用。
如果SOC或嵌入式系统的程序比较复杂，牵涉到进程调度、I/O作业和中断等，就不可避免地要在芯片上安排实时操作系统。这是一种服务于嵌入式系统的RTOS，称为嵌入式实时操作系统。

与普通的RTOS相比，**嵌入式实时操作系统不仅有实时性的要求，而且有容量的限制**。实时操作系统集中了计算机软件专家的智慧，并为无数应用系统证明是完全成功的，具有很高的质量，然而，**一般的实时操作系统容量比较大，内存的开销至少需要几百k字节，不适合嵌入式系统的应用要求，于是对这样的系统进行裁剪**。

首先，在嵌入式应用中**不需要文件管理的庞大内容**，此外**内存管理一般也可省去**，这样**只剩下I/O管理和进程管理**。**在嵌入式系统中，进程管理就是任务管理**。I/O操作的管理也可以当作若干个任务进行管理。计算机操作系统经过这样的精简后，**剩下的是实时操作系统中最为重要的内容，即多任务实时调度和任务的定时、同步操作**，其二进制代码仅几k字节，实时性变得更好，这部分内容通常称为**实时内核**。在嵌入式系统中，首先运行一个实时内核，然后**由这个实时内核管理应用程序中的各个任务，形成嵌入式实时多任务系统**。从这个意义上说，**实时内核就是所谓嵌入式实时操作系统**。

RTOS实行多进程管理，当系统受到强烈的干扰时，可能只是引起若干进程中的一个被破坏，而另外的进程运行时可对其进行修复。应用RTOS管理，不仅可以将应用程序分解成若干个独立的进程，而且可以另外启动一个监控程序，监视各进程的运行状况。这就提高了系统的抗干扰能力。

此外，RTOS的使用有利于提高开发效率。一个复杂的应用程序，可以分解成多个任务分别调试，设计人员编制完成各任务的执行程序后，只需将任务的启动条件、优先级等告诉RTOS，即可让RTOS专管理这些任务，大大缩短了产品的开发周期。

当然，使用RTOS需要占用一定的内存，此外，各任务也需要自己的寄存器和堆栈，这些都需要开销系统的内存资源。因此，如果需要用RTOS进行系统管理的话，在系统设计时必需留有足够的内存。

6.6.3 实时多任务调度

在嵌入式RTOS中任务的概念与计算机操作系统中任务的概念有所不同。计算机操作系统中，任务是用户递交给计算机的一项工作，一个任务可以由许多进程，每个进程还可以有多个线程。在嵌入式RTOS中的一个任务，是指一个程序分段，这个分段被操作系统当作一个基本单元来调度。实时应用程序的设计过程，是如何把应用问题分割成多个任务，每个任务都是整个应用的一部分，每个任务被赋于一定的优先级，有它自己的一套寄存器和堆栈空间。
通常每个任务都是一个无限的循环。每个任务都处于以下5种状态之一。这5种状态是：休眠态、就绪态、运行态、等待态和被中断态。休眠态相当于该任务驻留在内存中，但并不被多任务内核调度。就绪态是指该任务已经准备好，可以运行了，但由于某种原因暂时还不能运行。运行态指该任务掌握了CPU的控制权，正在运行中。等待态指该任务在等待某一事件的发生，例如等待外设的I/O操作，或等待定时脉冲到来或等待超时信号到来以结束目前的等待，等等。最后，当发生中断时，CPU进行相应的中断服务，原来正在运行的任务暂不能运行，此时就进入了被中断状态。

多任务运行的实现实际上是靠RTOS在许多任务之间进行调度和切换。

调度（scheduler或dispatch）是RTOS内核的主要职责，调度要决定转到哪个任务运行。一旦RTOS内核决定运行另外的任务时，它保留正在运行任务的当前状态，即CPU寄存器中的全部内容。这些内容保存在任务自己的栈区中，然后把下一个将要运行任务的栈中的内容重新装入到CPU的寄存器中，开始下一个任务的运行。这个过程叫做任务切换。任务切换过程增加了系统内存的开销。

常用的实时调度法主要有三种，即单调执行率调度法，最早截止优先调度法和时间裕度调度法，而以单调执行率调度法最为常用。

单调执行率调度法事先为每个任务分配一个与事件发生频率成正比的优先级，RTOS内核总是调度优先级最高的就绪任务，必要时将剥夺当前任务的CPU使用权，让高优先级的任务先运行。这种调度方法是大部分实时内核所采用的调度方式，被大量实际应用证明是最优先的。

在采用单调执行率调度法时，如果有n个任务都要满足是硬实时条件，则必须满足下面的不等式：

上式即单调执行率调度定理。在式（6-7）中，ti是任务i最长执行时间，Ti是任务i的执行周期，即ti/Ti是任务i所占用CPU时间的比例。当n=1即只有1个任务时，式（6-7）右边的值为1, CPU可以全部归该任务使用。当n=2,3, …时，式（6-7）的右边分别为0.828,0.779,…。当n→∞时，

就是说，基于单调执行率调度法，要多任务都满足硬实时条件时，所有任务总的占用CPU时间的比例应小于69.3%。当然，这时候可以允许CPU处理其他没有时间要求的任务。

另一种常用的实时调度法为最早截止优先调度法。当一个事件发生时，对应的任务被加到就绪队列中，该队列按照截止期限排序，截止周期最短的优先权最高。

第三种实时调度法是时间裕度调度法。如果一个任务需要运行200ms，而它必须在250ms内完成，则其时间裕度为50ms。时间裕度最少的任务优先级最高。

6.6.4 信号与信号量（semaphore）

内核在进行调度时，高优级的任务由就绪态进入运行有两种方式。一种方式是，高优级任务就绪后，必须等待当前运行任务主动将CPU控制权释放后才能控制CPU，进入运行状态。这种多任务实时内核是不可剥夺型内核，这种内核的实时性取决于最长任务的执行时间。如果最长任务的执行时间不能确定，则系统的实时性也不能确定。另一种方式是，一旦高优级任务就绪后，就剥夺当前运行任务的CPU控制权，转而执行该高优级任务。采用这种方式管理多任务调度的RTOS内核称为可剥夺型内核。可剥夺型内核的实时性最好，不可剥夺型内核的实时性其次，无RTOS的系统实时性最差。然而，可剥夺型内核在任务调度时，必须处理好任务之间的竞争，否则会产生系统崩溃，死机等严重后果。目前商品化的RTOS都是可剥夺型的，其任务调度时的竞争问题解决得相当完善。

信号与信号量就是在多任务内核中为避免任务间的竞争而普遍使用的方法。在多任务内核中，信号是一个信令，任务要运行下去，必须已得到这个信令。如果信号已被别的任务占用，该任务只得被挂起，直到信号被当前使用者释放。信号是只有“0”，“1”两个值的变量。信号量是计数式的，其值可以是0～255或0～65535，取决于信号量规约机制使用的是8位还是16位。由于信号是只取两个值0和1的量，因此，也可将其称之为信号量。

信号量用于：

●控制共享资源的使用权，多任务内核必须保证每个任务在处理共享数据时的排它性，避免竞争和数据的破坏。
●标志某事件的发生；
●使两个任务的行为同步。

一般地说，对信号量只能实施三种操作：**建立（create），等信号（wait）**，也可称为**挂起（pend）**，**给信号（signal）**或者**发信号（post）**。

想要得到信号量的任务执行等待操作，如果该信号量有效（即信号量值大于0），则信号量值减1，任务得以继续执行；如果信号量的值为0，等待信号量的任务就被列入等待信号量任务表。多数内核允许用户定义等待超时，如果等待时间超过了设定值，该信号量还是无效，则等待信号量的任务就进入就绪态准备运行，并返回超时等待的出错信息。
任务以发信号操作释放信号量。如果没有任务在等待信号量，则信号量的值仅仅是简单地加1；如果有任务在等待该信号量，那么就会有一个任务进入就绪态，信号量的值也就不加1。于是信令给了等待信号的诸任务中的一个任务。至于给哪个任务，要看内核是如何调度的。

习题6

6-1 概述SOC的结构特点和设计方法。
6-2 简述RISC处理器的结构特点和指令集特点。
6-3 简述指令级并行处理的主要方法。
6-4 简述软硬件协同设计的主要步骤和方法，并指出其和一般软、硬件设计的区别。
6-5 概述嵌入式系统和嵌入式实时操作系统的特点。